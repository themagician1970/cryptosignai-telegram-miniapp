<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="format-detection" content="telephone=no">
    <title>CryptoSignAI - Advanced Trading Platform</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            padding: 10px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            background: transparent;
            color: white;
            font-size: 14px;
            font-weight: 600;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            min-height: 44px;
        }
        .nav-tab.active {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .grid {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }
        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .card h3 {
            margin-bottom: 15px;
            color: #FFD700;
            font-size: 1.2rem;
        }
        .btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin: 5px;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            min-height: 44px;
            width: 100%;
        }
        .btn:active {
            transform: scale(0.98);
            background: linear-gradient(45deg, #45a049, #4CAF50);
        }
        .btn-secondary {
            background: linear-gradient(45deg, #2196F3, #1976D2);
        }
        .btn-secondary:active {
            background: linear-gradient(45deg, #1976D2, #2196F3);
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .signal-card {
            text-align: center;
            padding: 20px;
        }
        .signal-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1rem;
            margin: 10px 0;
        }
        .signal-buy {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }
        .signal-sell {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
        }
        .signal-hold {
            background: linear-gradient(45deg, #FFA500, #FF8C00);
            color: white;
        }
        .confidence-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #FFD700);
            transition: width 0.5s ease;
        }
        .trading-analysis {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #4CAF50;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .trading-analysis h4 {
            color: #FFD700;
            margin-bottom: 15px;
            font-size: 1.1rem;
            text-align: center;
        }
        .analysis-section {
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .analysis-section:last-child {
            border-bottom: none;
        }
        .analysis-label {
            color: #FFD700;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .analysis-value {
            color: white;
            margin-left: 10px;
        }
        .entry-point, .take-profit, .stop-loss {
            margin: 5px 0;
            padding: 5px 10px;
            border-radius: 5px;
        }
        .entry-point {
            background: rgba(33, 150, 243, 0.2);
            border-left: 3px solid #2196F3;
        }
        .take-profit {
            background: rgba(76, 175, 80, 0.2);
            border-left: 3px solid #4CAF50;
        }
        .stop-loss {
            background: rgba(244, 67, 54, 0.2);
            border-left: 3px solid #f44336;
        }
        .risk-reward {
            text-align: center;
            padding: 10px;
            background: rgba(255, 193, 7, 0.2);
            border-radius: 8px;
            margin: 10px 0;
        }
        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            .nav-tab {
                font-size: 12px;
                padding: 12px 8px;
            }
            .header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ CryptoSignAI</h1>
            <p><span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #4CAF50; margin-right: 8px;"></span>Advanced AI Trading Platform</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="signals">‚ö° Signals</button>
            <button class="nav-tab" data-tab="charts">üìà Charts</button>
            <button class="nav-tab" data-tab="portfolio">üíº Portfolio</button>
            <button class="nav-tab" data-tab="news">üì∞ News</button>
        </div>

        <!-- Signals Tab -->
        <div id="signals" class="tab-content active">
            <div class="grid grid-2">
                <div class="card">
                    <h3>AI Analysis</h3>
                    <select id="analysis-symbol" style="width: 100%; padding: 10px; border-radius: 5px; margin-bottom: 15px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3);">
                        <option value="bitcoin">Bitcoin (BTC)</option>
                        <option value="ethereum">Ethereum (ETH)</option>
                        <option value="binancecoin">BNB</option>
                        <option value="cardano">Cardano (ADA)</option>
                        <option value="solana">Solana (SOL)</option>
                        <option value="US100">NASDAQ 100 (US100)</option>
                    </select>
                    <button class="btn" id="analyze-btn">üîç Analyze</button>
                    
                    <!-- Telegram Button Controls -->
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 10px; margin: 15px 0;">
                        <h4 style="color: #FFD700; margin-bottom: 15px;">üéõÔ∏è Telegram Controls</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button id="toggle-back-btn" class="btn" style="background: #FF6B35;">
                                Show Back Button
                            </button>
                            <button id="toggle-settings-btn" class="btn" style="background: #4ECDC4;">
                                Show Settings Button
                            </button>                        <button id="toggle-main-btn" class="btn" style="background: #45B7D1;">
                            Hide Main Button
                        </button>
                        <button id="debug-test-btn" class="btn" style="background: #E74C3C;">
                            üîß Test Debug
                        </button>
                        </div>
                    </div>
                    
                    <div id="analysis-result">Select a symbol and click Analyze</div>
                </div>
                
                <div class="card">
                    <h3>Quick Signals</h3>
                    <button class="btn btn-secondary" id="quick-signals-btn">‚ö° Get Signals</button>
                    <div id="quick-signals">Click to get quick trading signals</div>
                </div>
            </div>
        </div>

        <!-- Charts Tab -->
        <div id="charts" class="tab-content">
            <div class="grid grid-2">
                <div class="card">
                    <h3>Trading Charts</h3>
                    <select id="chart-symbol" style="width: 100%; padding: 10px; border-radius: 5px; margin-bottom: 15px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3);">
                        <option value="BTCUSD">Bitcoin (BTC/USD)</option>
                        <option value="ETHUSD">Ethereum (ETH/USD)</option>
                        <option value="BNBUSD">BNB (BNB/USD)</option>
                        <option value="ADAUSD">Cardano (ADA/USD)</option>
                        <option value="SOLUSD">Solana (SOL/USD)</option>
                        <option value="NAS100">NASDAQ 100</option>
                        <option value="SPX500">S&P 500</option>
                        <option value="EURUSD">EUR/USD</option>
                        <option value="XAUUSD">Gold (XAU/USD)</option>
                    </select>
                    <div style="height: 300px; background: rgba(255, 255, 255, 0.05); border-radius: 10px; margin: 15px 0; display: flex; align-items: center; justify-content: center;">
                        üìà Chart will be displayed here
                    </div>
                </div>
                
                <div class="card">
                    <h3>üìä Professional Chart Analysis</h3>
                    <div style="margin-bottom: 15px;">
                        <input type="file" id="chart-upload" accept="image/*" style="display: none;">
                        <button class="btn" id="upload-chart-btn">üì∏ Upload Chart</button>
                        <button class="btn btn-secondary" id="live-analysis-btn">‚ö° Live Analysis</button>
                    </div>
                    <div id="chart-analysis-result">
                        <div style="text-align: center; padding: 20px; opacity: 0.7;">
                            üìà Upload a chart or get live analysis for professional trading signals
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Tab -->
        <div id="portfolio" class="tab-content">
            <div class="card">
                <h3>Portfolio Overview</h3>
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 2rem; color: #FFD700; margin-bottom: 10px;">$12,450.75</div>
                    <div style="color: #4CAF50; font-size: 1.2rem;">+5.2% ($615.30)</div>
                    <div style="margin-top: 20px; opacity: 0.7;">24h Change</div>
                </div>
            </div>
        </div>

        <!-- News Tab -->
        <div id="news" class="tab-content">
            <div class="card">
                <h3>Market News & Updates</h3>
                <div style="padding: 20px; text-align: center; opacity: 0.7;">
                    üì∞ Latest market news will be displayed here
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('üöÄ CryptoSignAI Loading...');
        
        // Initialize Telegram WebApp with proper error handling
        let tg = window.Telegram?.WebApp;
        let currentAction = null;
        let backButton = null;
        let settingsButton = null;
        
        // Telegram WebApp Initialization
        function initTelegramWebApp() {
            try {
                if (tg) {
                    console.log('üîÑ Initializing Telegram WebApp...');
                    
                    // Initialize the WebApp - REQUIRED FIRST
                    tg.ready();
                    
                    // Expand to full height
                    tg.expand();
                    
                    // Set app theme
                    document.body.style.background = tg.themeParams.bg_color || '#1e3c72';
                    
                    // Enable closing confirmation
                    tg.enableClosingConfirmation();
                    
                    // Setup Main Button
                    if (tg.MainButton) {
                        tg.MainButton.setText('üöÄ Analyze Crypto');
                        tg.MainButton.color = tg.themeParams.button_color || '#4CAF50';
                        tg.MainButton.textColor = tg.themeParams.button_text_color || '#FFFFFF';
                        tg.MainButton.show();
                        
                        // Clear any existing handlers and add new one
                        tg.MainButton.offClick();
                        tg.MainButton.onClick(handleMainButtonClick);
                    }
                    
                    // Setup Back Button
                    if (tg.BackButton) {
                        backButton = tg.BackButton;
                        backButton.onClick(handleBackButtonClick);
                        console.log('‚úÖ Back Button initialized');
                    }
                    
                    // Setup Settings Button  
                    if (tg.SettingsButton) {
                        settingsButton = tg.SettingsButton;
                        settingsButton.onClick(handleSettingsButtonClick);
                        console.log('‚úÖ Settings Button initialized');
                    }
                    
                    // Add event handlers
                    tg.onEvent('mainButtonClicked', handleMainButtonClick);
                    tg.onEvent('backButtonClicked', handleBackButtonClick);
                    tg.onEvent('settingsButtonClicked', handleSettingsButtonClick);
                    tg.onEvent('viewportChanged', function() {
                        console.log('Viewport changed:', tg.viewportHeight);
                    });
                    
                    console.log('‚úÖ Telegram WebApp initialized successfully');
                    console.log('User info:', tg.initDataUnsafe?.user);
                    
                    return true;
                } else {
                    console.log('‚ö†Ô∏è Telegram WebApp not available - running in browser mode');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Telegram WebApp initialization failed:', error);
                return false;
            }
        }
        
        // Main Button click handler
        function handleMainButtonClick() {
            console.log('üöÄ Main Button clicked');
            
            try {
                // Haptic feedback
                if (tg?.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('medium');
                }
                
                // Execute current action or default
                if (currentAction) {
                    currentAction();
                } else {
                    analyzeSymbol('bitcoin');
                }
            } catch (error) {
                console.error('‚ùå Main Button click error:', error);
            }
        }
        
        // Back Button click handler
        function handleBackButtonClick() {
            console.log('‚¨ÖÔ∏è Back Button clicked');
            
            try {
                // Haptic feedback
                if (tg?.HapticFeedback) {
                    tg.HapticFeedback.selectionChanged();
                }
                
                // Navigate back to main tab
                showTab('market-analysis');
                
                // Hide back button after use
                if (backButton) {
                    backButton.hide();
                }
                
                // Update main button
                updateMainButton('üöÄ Analyze Crypto', () => analyzeSymbol());
                
            } catch (error) {
                console.error('‚ùå Back Button click error:', error);
            }
        }
        
        // Settings Button click handler  
        function handleSettingsButtonClick() {
            console.log('‚öôÔ∏è Settings Button clicked');
            
            try {
                // Haptic feedback
                if (tg?.HapticFeedback) {
                    tg.HapticFeedback.selectionChanged();
                }
                
                // Navigate to settings tab
                showTab('chart-analysis');
                
                // Show back button when in settings
                if (backButton) {
                    backButton.show();
                }
                
                // Update main button for settings context
                updateMainButton('‚öôÔ∏è Configure Settings', null);
                
            } catch (error) {
                console.error('‚ùå Settings Button click error:', error);
            }
        }
        
        // Toggle functions like B4X example
        function toggleBackButton() {
            if (backButton) {
                if (backButton.isVisible) {
                    backButton.hide();
                    document.getElementById('toggle-back-btn').textContent = 'Show Back Button';
                    console.log('‚¨ÖÔ∏è Back Button hidden');
                } else {
                    backButton.show();
                    document.getElementById('toggle-back-btn').textContent = 'Hide Back Button';
                    console.log('‚¨ÖÔ∏è Back Button shown');
                }
                
                // Haptic feedback
                if (tg?.HapticFeedback) {
                    tg.HapticFeedback.selectionChanged();
                }
            } else {
                console.log('‚ö†Ô∏è Back Button not available');
            }
        }
        
        function toggleSettingsButton() {
            if (settingsButton) {
                if (settingsButton.isVisible) {
                    settingsButton.hide();
                    document.getElementById('toggle-settings-btn').textContent = 'Show Settings Button';
                    console.log('‚öôÔ∏è Settings Button hidden');
                } else {
                    settingsButton.show();
                    document.getElementById('toggle-settings-btn').textContent = 'Hide Settings Button';
                    console.log('‚öôÔ∏è Settings Button shown');
                }
                
                // Haptic feedback
                if (tg?.HapticFeedback) {
                    tg.HapticFeedback.selectionChanged();
                }
            } else {
                console.log('‚ö†Ô∏è Settings Button not available');
            }
        }
        
        function toggleMainButton() {
            if (tg?.MainButton) {
                if (tg.MainButton.isVisible) {
                    tg.MainButton.hide();
                    document.getElementById('toggle-main-btn').textContent = 'Show Main Button';
                    console.log('üöÄ Main Button hidden');
                } else {
                    tg.MainButton.show();
                    document.getElementById('toggle-main-btn').textContent = 'Hide Main Button';
                    console.log('üöÄ Main Button shown');
                }
                
                // Haptic feedback
                if (tg?.HapticFeedback) {
                    tg.HapticFeedback.selectionChanged();
                }
            } else {
                console.log('‚ö†Ô∏è Main Button not available');
            }
        }

        // Core functions
        function updateDisplay(elementId, content) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = content;
                console.log(`üìù Updated ${elementId}`);
            } else {
                console.error(`‚ùå Element ${elementId} not found`);
            }
        }

        function updateMainButton(text, action) {
            if (tg && tg.MainButton) {
                tg.MainButton.setText(text);
                currentAction = action;
                console.log(`üîÑ Main button updated: ${text}`);
            }
        }

        function showTab(tabName) {
            console.log('üîÑ Switching to tab:', tabName);
            
            if (tg && tg.HapticFeedback) {
                tg.HapticFeedback.selectionChanged();
            }
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            const targetTab = document.getElementById(tabName);
            const targetNav = document.querySelector(`[data-tab="${tabName}"]`);
            
            if (targetTab) targetTab.classList.add('active');
            if (targetNav) targetNav.classList.add('active');
            
            // Update main button based on active tab
            switch(tabName) {
                case 'signals':
                    updateMainButton('‚ö° Generate Analysis', analyzeSymbol);
                    break;
                case 'charts':
                    updateMainButton('üìä Live Analysis', generateLiveAnalysis);
                    break;
                case 'portfolio':
                    updateMainButton('üíº Portfolio Ready', null);
                    break;
                case 'news':
                    updateMainButton('üì∞ News Ready', null);
                    break;
                default:
                    updateMainButton('üöÄ Ready to Trade', null);
            }
        }

        async function analyzeSymbol() {
            console.log('üîç Analyze function called - ENTRY POINT');
            console.log('üîç Button clicked at:', new Date().toISOString());
            
            if (tg && tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('medium');
            }
            
            const symbolElement = document.getElementById('analysis-symbol');
            console.log('üîç Symbol element:', symbolElement);
            
            const symbol = symbolElement ? symbolElement.value : 'bitcoin';
            console.log('üîç Selected symbol:', symbol);
            
            updateDisplay('analysis-result', '<div class="loading"></div> üîÑ Analyzing...');
            updateMainButton('üîÑ Analyzing...', null);
            
            try {
                console.log('üîç Making API request to:', `/api/analyze?symbol=${symbol}`);
                const response = await fetch(`/api/analyze?symbol=${symbol}`);
                console.log('üîç API Response status:', response.status);
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                console.log('‚úÖ Analysis result:', data);
                
                updateDisplay('analysis-result', `
                    <div class="signal-card">
                        <h4>${data.symbol}</h4>
                        <div style="font-size: 1.2rem; margin: 10px 0;">$${data.price.toLocaleString()}</div>
                        <div style="color: ${data.change >= 0 ? '#4CAF50' : '#f44336'}; margin: 10px 0;">
                            ${data.change >= 0 ? '+' : ''}${data.change.toFixed(2)}%
                        </div>
                        <div class="signal-badge signal-${data.signal.toLowerCase()}">${data.signal}</div>
                        <div style="margin: 10px 0;">Confidence: ${data.confidence}%</div>
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${data.confidence}%"></div>
                        </div>
                        <div style="font-size: 0.9rem; margin-top: 10px; opacity: 0.8;">
                            Risk Level: ${data.riskLevel}
                        </div>
                    </div>
                `);
                
                updateMainButton('‚úÖ Analysis Complete', analyzeSymbol);
                
                if (tg && tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('success');
                }
                
            } catch (error) {
                console.error('‚ùå Analysis error:', error);
                updateDisplay('analysis-result', '<div style="color: #f44336;">‚ùå Analysis failed. Please try again.</div>');
                updateMainButton('‚ùå Try Again', analyzeSymbol);
                
                if (tg && tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('error');
                }
            }
        }

        async function generateLiveAnalysis() {
            console.log('‚ö° Live analysis function called');
            
            if (tg && tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('heavy');
            }
            
            const symbol = document.getElementById('chart-symbol').value;
            updateDisplay('chart-analysis-result', '<div class="loading"></div> Generating live analysis...');
            updateMainButton('üîÑ Analyzing Chart...', null);
            
            try {
                const response = await fetch('/api/chart-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: symbol, chartData: 'live-analysis' })
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                console.log('‚úÖ Live analysis result:', data);
                
                if (data.success) {
                    const analysis = data.analysis;
                    updateDisplay('chart-analysis-result', `
                        <div class="trading-analysis">
                            <h4>üìä PROFESSIONAL ANALYSIS</h4>
                            
                            <div class="analysis-section">
                                <div class="analysis-label">Signal:</div>
                                <div class="analysis-value"><strong>${analysis.signal}</strong> (${analysis.trend})</div>
                            </div>
                            
                            <div class="analysis-section">
                                <div class="analysis-label">Entry Point:</div>
                                <div class="entry-point">
                                    $${analysis.entryPrice.toFixed(2)}<br>
                                    ${analysis.entryConfirmation}
                                </div>
                            </div>
                            
                            <div class="analysis-section">
                                <div class="analysis-label">Take Profit Levels:</div>
                                <div class="take-profit">
                                    TP1: $${analysis.takeProfitLevels.tp1.price.toFixed(2)} (+${analysis.takeProfitLevels.tp1.gain}%)<br>
                                    TP2: $${analysis.takeProfitLevels.tp2.price.toFixed(2)} (+${analysis.takeProfitLevels.tp2.gain}%)<br>
                                    TP3: $${analysis.takeProfitLevels.tp3.price.toFixed(2)} (+${analysis.takeProfitLevels.tp3.gain}%)
                                </div>
                            </div>
                            
                            <div class="analysis-section">
                                <div class="analysis-label">Stop Loss:</div>
                                <div class="stop-loss">
                                    $${analysis.stopLoss.price.toFixed(2)} (${analysis.stopLoss.risk}% risk)
                                </div>
                            </div>
                            
                            <div class="risk-reward">
                                <div class="analysis-label">Risk Management:</div>
                                <div>R:R Ratio: 1:${analysis.riskReward}</div>
                            </div>
                        </div>
                    `);
                    
                    updateMainButton('‚úÖ Chart Analysis Complete', generateLiveAnalysis);
                } else {
                    updateDisplay('chart-analysis-result', '<div style="color: #FFA500;">‚ö†Ô∏è Using fallback analysis. Please try again.</div>');
                    updateMainButton('‚ö†Ô∏è Try Again', generateLiveAnalysis);
                }
                
                if (tg && tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('success');
                }
                
            } catch (error) {
                console.error('‚ùå Live analysis error:', error);
                updateDisplay('chart-analysis-result', '<div style="color: #f44336;">‚ùå Analysis failed. Please try again.</div>');
                updateMainButton('‚ùå Try Again', generateLiveAnalysis);
                
                if (tg && tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('error');
                }
            }
        }

        async function getQuickSignals() {
            console.log('‚ö° Quick signals function called');
            
            updateDisplay('quick-signals', '<div class="loading"></div> Getting signals...');
            
            try {
                const response = await fetch('/api/quick-signals');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                console.log('‚úÖ Quick signals result:', data);
                
                if (data.success) {
                    updateDisplay('quick-signals', data.signals.map(signal => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 8px 0; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <div>
                                <div style="font-weight: 600;">${signal.symbol}</div>
                                <div style="font-size: 0.9rem;">$${signal.price.toLocaleString()}</div>
                            </div>
                            <div style="text-align: right;">
                                <div class="signal-badge signal-${signal.signal.toLowerCase()}" style="font-size: 0.8rem; padding: 4px 12px;">
                                    ${signal.signal}
                                </div>
                                <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.8;">
                                    ${signal.confidence}% confident
                                </div>
                            </div>
                        </div>
                    `).join(''));
                } else {
                    updateDisplay('quick-signals', '<div style="color: #f44336;">Failed to load signals</div>');
                }
            } catch (error) {
                console.error('‚ùå Signals error:', error);
                updateDisplay('quick-signals', '<div style="color: #f44336;">Failed to load signals</div>');
            }
        }

        // Setup event listeners with proper touch handling
        function setupEventListeners() {
            console.log('üîß Setting up event listeners...');
            
            // Navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                const handler = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const tabName = this.getAttribute('data-tab');
                    showTab(tabName);
                };
                
                // Use both click and touchend for maximum compatibility
                tab.addEventListener('click', handler, { passive: false });
                tab.addEventListener('touchend', handler, { passive: false });
                console.log('‚úÖ Tab event listener added for:', tab.getAttribute('data-tab'));
            });

            // Button handlers - Using standard event listeners
            const buttonHandlers = [
                { id: 'analyze-btn', handler: analyzeSymbol, name: 'Analyze' },
                { id: 'quick-signals-btn', handler: getQuickSignals, name: 'Quick Signals' },
                { id: 'live-analysis-btn', handler: generateLiveAnalysis, name: 'Live Analysis' },
                { id: 'upload-chart-btn', handler: () => document.getElementById('chart-upload').click(), name: 'Upload Chart' },
                { id: 'toggle-back-btn', handler: toggleBackButton, name: 'Toggle Back Button' },
                { id: 'toggle-settings-btn', handler: toggleSettingsButton, name: 'Toggle Settings Button' },
                { id: 'toggle-main-btn', handler: toggleMainButton, name: 'Toggle Main Button' },
                { id: 'debug-test-btn', handler: () => { 
                    console.log('üîß DEBUG TEST BUTTON CLICKED!'); 
                    alert('Debug test button works!'); 
                }, name: 'Debug Test' }
            ];

            buttonHandlers.forEach(({ id, handler, name }) => {
                const element = document.getElementById(id);
                console.log(`üîç Setting up button: ${name} (${id})`, element ? 'FOUND' : 'NOT FOUND');
                
                if (element) {
                    const eventHandler = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log(`üöÄ ${name} button clicked - HANDLER TRIGGERED`);
                        console.log('üöÄ Event details:', e.type, e.target.id);
                        
                        // Visual feedback
                        this.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            this.style.transform = '';
                        }, 150);
                        
                        console.log(`üöÄ About to call handler for ${name}`);
                        try {
                            handler();
                            console.log(`‚úÖ Handler executed successfully for ${name}`);
                        } catch (error) {
                            console.error(`‚ùå Handler error for ${name}:`, error);
                        }
                    };
                    
                    // Multiple event types for maximum compatibility
                    element.addEventListener('click', eventHandler, { passive: false });
                    element.addEventListener('touchend', eventHandler, { passive: false });
                    element.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        this.style.transform = 'scale(0.95)';
                        console.log(`üëÜ ${name} button touch started`);
                    }, { passive: false });
                    
                    console.log(`‚úÖ ${name} button events attached successfully`);
                } else {
                    console.error(`‚ùå ${name} button (${id}) not found in DOM`);
                }
            });

            // Chart upload handler
            const uploadInput = document.getElementById('chart-upload');
            if (uploadInput) {
                uploadInput.addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    if (file) {
                        updateDisplay('chart-analysis-result', `
                            <div style="color: #4CAF50;">‚úÖ Chart uploaded: ${file.name}</div>
                            <div style="margin-top: 10px;">Analysis would be performed here</div>
                        `);
                    }
                });
                console.log('‚úÖ Chart upload handler attached');
            }

            console.log('‚úÖ All event listeners setup complete');
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            console.log('üìÑ DOM is loading, adding event listener...');
            document.addEventListener('DOMContentLoaded', function() {
                console.log('üìÑ DOM Content Loaded - initializing...');
                setupEventListeners();
                initTelegramWebApp();
            });
        } else {
            console.log('üìÑ DOM already ready - initializing immediately...');
            setupEventListeners();
            initTelegramWebApp();
        }
        
        // Global click debugging
        document.addEventListener('click', function(e) {
            console.log('üñ±Ô∏è Global click detected:', {
                tag: e.target.tagName,
                id: e.target.id,
                class: e.target.className,
                text: e.target.textContent?.substring(0, 50)
            });
        });
        
        // Log when page fully loads
        window.addEventListener('load', function() {
            console.log('üåê Page fully loaded');
            console.log('üîç Available buttons:', Array.from(document.querySelectorAll('button')).map(b => b.id || b.textContent?.substring(0, 20)));
        });

        // Debug logging for interaction tracking
        document.addEventListener('click', function(e) {
            console.log('üñ±Ô∏è Click detected:', e.target.tagName, e.target.id || e.target.className);
        });

        document.addEventListener('touchend', function(e) {
            console.log('üëÜ Touch detected:', e.target.tagName, e.target.id || e.target.className);
        });

        // Prevent context menu and long press issues
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });

        document.addEventListener('selectstart', function(e) {
            e.preventDefault();
        });

        console.log('üöÄ CryptoSignAI Platform Loaded with Telegram Integration');
    </script>
</body>
</html>
